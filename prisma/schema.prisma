// Prisma schema for Therapy Practice Management System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== Authentication ====================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ==================== Core Models ====================

enum Role {
  USER
  MANAGER  // משתמש עם הרשאות ניהול
  ADMIN
}

model User {
  id                      String    @id @default(cuid())
  name                    String?
  email                   String?   @unique
  emailVerified           DateTime?
  image                   String?
  password                String?
  phone                   String?
  license                 String?
  role                    Role      @default(USER)
  isBlocked               Boolean   @default(false)
  defaultSessionDuration  Int       @default(50) // משך פגישה סטנדרטית בדקות
  
  // AI & Billing Settings
  aiTier                  AITier    @default(ESSENTIAL) // Essential, Pro, Enterprise
  therapeuticApproaches   String[]  @default([]) // Array of approaches: ["CBT", "Psychodynamic", etc.]
  approachDescription     String?   @db.Text // Custom description for eclectic approach
  analysisStyle           String    @default("professional") // professional, practical, emotional
  aiTone                  String    @default("formal") // formal, warm, direct
  customAIInstructions    String?   @db.Text // Custom instructions for AI
  
  // Billing
  stripeCustomerId        String?   @unique // Stripe customer ID
  stripeSubscriptionId    String?   @unique // Stripe subscription ID
  subscriptionStatus      SubscriptionStatus @default(ACTIVE)
  subscriptionStartedAt   DateTime?
  subscriptionEndsAt      DateTime?
  trialEndsAt             DateTime?
  
  // Usage limits
  maxActiveClients        Int       @default(40) // Maximum active clients allowed
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt

  accounts              Account[]
  sessions              Session[]
  clients               Client[]
  therapySessions       TherapySession[]
  documents             Document[]
  notifications         Notification[]
  tasks                 Task[]
  notificationSettings  NotificationSetting[]
  recurringPatterns     RecurringPattern[]
  intakeTemplates       IntakeTemplate[]
  apiUsageLogs          ApiUsageLog[]
  subscriptionPayments  SubscriptionPayment[]
  reviewedCancellations CancellationRequest[]
  communicationLogs     CommunicationLog[]
  communicationSetting  CommunicationSetting?
  couponUsages          CouponUsage[]
  questionnaireResponses QuestionnaireResponse[]
  intakeQuestionnaires  IntakeQuestionnaire[] @relation("intakeQuestionnaires")
  passwordResets        PasswordReset[]
  smsSettings           SMSSettings?
  consentForms          ConsentForm[]
  insurerSettings       InsurerSettings?
  insurerReports        InsurerReport[]
  billingProviders      BillingProvider[]
  aiUsageStats          AIUsageStats?
  sessionPreps          SessionPrep[]
  
  // AI Insights Relations
  aiInsights            AIInsight[]
  therapeuticGoals      TherapeuticGoal[]
  emotionLogs           EmotionLog[]
  
  // AI Analysis Relations
  questionnaireAnalyses QuestionnaireAnalysis[]
  sessionAnalyses       SessionAnalysis[]
  monthlyUsages         MonthlyUsage[]
}

// ==================== AI Tiers ====================

enum AITier {
  ESSENTIAL    // 117₪ - ללא AI
  PRO          // 145₪ - Gemini 2.0 Flash (תמציתי) - מוצג כ"מקצועי" בממשק
  ENTERPRISE   // 220₪ - Gemini 2.0 Flash (מפורט עם גישות) - מוצג כ"ארגוני" בממשק
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELLED
  PAUSED
}

// ==================== Admin Alerts System ====================

model AdminAlert {
  id            String          @id @default(cuid())
  type          AdminAlertType
  priority      AlertPriority   @default(MEDIUM)
  status        AlertStatus     @default(PENDING)
  
  // Alert details
  title         String
  message       String          @db.Text
  
  // Related entities (optional)
  userId        String?
  
  // Action tracking
  actionRequired String?        // מה צריך לעשות
  actionTaken   String?         @db.Text // מה נעשה
  resolvedAt    DateTime?
  resolvedBy    String?         // Admin ID who resolved
  
  // Scheduling for reminders
  scheduledFor  DateTime?       // מתי להציג/לשלוח
  emailSent     Boolean         @default(false)
  emailSentAt   DateTime?
  
  // Metadata
  metadata      Json?           // Additional data (payment IDs, amounts, etc.)
  
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  
  @@index([type, status])
  @@index([userId])
  @@index([scheduledFor])
  @@index([priority, status])
}

enum AdminAlertType {
  PAYMENT_DUE           // תשלום קרב
  PAYMENT_OVERDUE       // תשלום באיחור
  PAYMENT_FAILED        // תשלום נכשל
  SUBSCRIPTION_EXPIRING // מנוי עומד לפוג
  SUBSCRIPTION_EXPIRED  // מנוי פג
  HIGH_AI_USAGE         // שימוש גבוה ב-AI
  NEW_USER              // משתמש חדש נרשם
  USER_BLOCKED          // משתמש נחסם
  TIER_CHANGE_REQUEST   // בקשה לשינוי תוכנית
  MANUAL_REMINDER       // תזכורת ידנית
  SYSTEM                // התראת מערכת
}

enum AlertPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum AlertStatus {
  PENDING     // טרם טופל
  IN_PROGRESS // בטיפול
  RESOLVED    // טופל
  DISMISSED   // נדחה
  SNOOZED     // נדחה לזמן מאוחר
}

// ==================== Password Reset ====================

model PasswordReset {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([token])
  @@index([userId])
}

model Client {
  id                  String       @id @default(cuid())
  firstName           String?
  lastName            String?
  name                String
  phone               String?
  email               String?
  birthDate           DateTime?
  address             String?
  status              ClientStatus @default(ACTIVE)
  defaultSessionPrice Decimal?     @db.Decimal(10, 2)
  creditBalance       Decimal      @default(0) @db.Decimal(10, 2) // יתרת קרדיט
  medicalHistory      Json?
  notes               String?      @db.Text
  initialDiagnosis    String?      @db.Text
  intakeNotes         String?      @db.Text
  
  // AI Settings - client-specific therapeutic approaches (override therapist defaults)
  therapeuticApproaches String[]   @default([]) // Override therapist's default approaches
  approachNotes         String?    @db.Text     // Special notes about therapeutic approach for this client
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  therapistId String
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  therapySessions      TherapySession[]
  payments             Payment[]
  documents            Document[]
  recordings           Recording[]
  recurringPatterns    RecurringPattern[]
  cancellationRequests CancellationRequest[]
  communicationLogs    CommunicationLog[]
  questionnaireResponses QuestionnaireResponse[]
  intakeResponses      IntakeResponse[] @relation("intakeResponses")
  consentForms         ConsentForm[]
  
  // AI Analysis Relations
  questionnaireAnalyses QuestionnaireAnalysis[]
  
  // AI Insights Relations
  aiInsights            AIInsight[]
  therapeuticGoals      TherapeuticGoal[]
  emotionLogs           EmotionLog[]
}

enum ClientStatus {
  ACTIVE
  WAITING
  INACTIVE
  ARCHIVED
}

model TherapySession {
  id          String        @id @default(cuid())
  startTime   DateTime
  endTime     DateTime
  status      SessionStatus @default(SCHEDULED)
  type        SessionType   @default(IN_PERSON)
  price       Decimal       @db.Decimal(10, 2)
  notes       String?       @db.Text
  location    String?
  isRecurring Boolean       @default(false)
  skipSummary Boolean       @default(false) // האם להסתיר מרשימת "ללא סיכום"

  // Cancellation fields
  cancellationReason      String?   @db.Text
  cancellationRequestedAt DateTime?
  cancelledAt             DateTime?
  cancelledBy             String? // 'CLIENT', 'THERAPIST', 'SYSTEM'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  therapistId String
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  sessionNote          SessionNote?
  payment              Payment?
  recordings           Recording[]
  cancellationRequests CancellationRequest[]
  communicationLogs    CommunicationLog[]
  smsReminders         SMSReminder[]
  insurerReports       InsurerReport[]
  
  // AI Analysis
  sessionAnalysis      SessionAnalysis?
  emotionLogs          EmotionLog[]
}

enum SessionStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  PENDING_CANCELLATION
  NO_SHOW
}

enum SessionType {
  IN_PERSON
  ONLINE
  PHONE
  BREAK
}

model SessionNote {
  id         String   @id @default(cuid())
  content    String   @db.Text
  isPrivate  Boolean  @default(false)
  aiAnalysis Json? // Stores AI analysis of the note
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  sessionId String         @unique
  session   TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}

// ==================== Recording & AI ====================

model Recording {
  id              String          @id @default(cuid())
  audioUrl        String
  durationSeconds Int
  type            RecordingType
  status          RecordingStatus @default(PENDING)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  sessionId String?
  session   TherapySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  transcription Transcription?
}

enum RecordingType {
  INTAKE
  SESSION
}

enum RecordingStatus {
  PENDING
  TRANSCRIBING
  TRANSCRIBED
  ANALYZED
  ERROR
}

model Transcription {
  id         String   @id @default(cuid())
  content    String   @db.Text
  language   String   @default("he")
  confidence Float?
  timestamps Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  recordingId String    @unique
  recording   Recording @relation(fields: [recordingId], references: [id], onDelete: Cascade)

  analysis Analysis?
}

model Analysis {
  id               String   @id @default(cuid())
  summary          String   @db.Text
  keyTopics        Json?
  emotionalMarkers Json?
  recommendations  Json?
  nextSessionNotes String?  @db.Text
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  transcriptionId String        @unique
  transcription   Transcription @relation(fields: [transcriptionId], references: [id], onDelete: Cascade)
}

// ==================== Payments ====================

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2) // הסכום ששולם בפועל
  expectedAmount Decimal?      @db.Decimal(10, 2) // הסכום המלא שהיה צריך להשתלם
  paymentType    PaymentType   @default(FULL) // סוג התשלום
  method         PaymentMethod
  status         PaymentStatus @default(PENDING)
  receiptUrl     String?
  notes          String?
  paidAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  sessionId String?         @unique
  session   TherapySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  // Parent-Child relation for partial payments
  parentPaymentId String?
  parentPayment   Payment?  @relation("PaymentChildren", fields: [parentPaymentId], references: [id], onDelete: Cascade)
  childPayments   Payment[] @relation("PaymentChildren")

  @@index([parentPaymentId])
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  BANK_TRANSFER
  CHECK
  CREDIT
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  CANCELLED
  REFUNDED
}

enum PaymentType {
  FULL     // תשלום מלא
  PARTIAL  // תשלום חלקי
  ADVANCE  // תשלום מראש (קרדיט)
}

// ==================== Documents ====================

model Document {
  id        String       @id @default(cuid())
  name      String
  type      DocumentType
  fileUrl   String
  signed    Boolean      @default(false)
  signedAt  DateTime?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  therapistId String
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
}

enum DocumentType {
  CONSENT_FORM
  INTAKE_FORM
  TREATMENT_PLAN
  REPORT
  OTHER
}

// ==================== Notifications & Tasks ====================

model Notification {
  id           String             @id @default(cuid())
  type         NotificationType
  title        String
  content      String             @db.Text
  status       NotificationStatus @default(PENDING)
  scheduledFor DateTime?
  sentAt       DateTime?
  readAt       DateTime?
  createdAt    DateTime           @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum NotificationType {
  MORNING_SUMMARY
  EVENING_SUMMARY
  PENDING_TASKS
  PAYMENT_REMINDER
  SESSION_REMINDER
  EMAIL_SENT
  EMAIL_RECEIVED
  CANCELLATION_REQUEST
  CUSTOM
}

enum NotificationStatus {
  PENDING
  SENT
  READ
  DISMISSED
}

model Task {
  id              String     @id @default(cuid())
  type            TaskType
  title           String
  description     String?    @db.Text
  status          TaskStatus @default(PENDING)
  priority        Priority   @default(MEDIUM)
  dueDate         DateTime?
  reminderAt      DateTime?
  relatedEntityId String?
  relatedEntity   String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum TaskType {
  WRITE_SUMMARY
  COLLECT_PAYMENT
  SIGN_DOCUMENT
  SCHEDULE_SESSION
  REVIEW_TRANSCRIPTION
  FOLLOW_UP
  CUSTOM
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model NotificationSetting {
  id                 String   @id @default(cuid())
  channel            String
  enabled            Boolean  @default(true)
  eveningTime        String? // Format: "HH:mm"
  morningTime        String? // Format: "HH:mm"
  debtThresholdDays  Int      @default(30)
  monthlyReminderDay Int? // 1-31, day of month for payment reminder
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== Recurring Sessions ====================

model RecurringPattern {
  id        String   @id @default(cuid())
  dayOfWeek Int // 0-6 (Sunday-Saturday)
  time      String // Format: "HH:mm"
  duration  Int      @default(50) // minutes
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)
}

// ==================== Intake Templates ====================

model IntakeTemplate {
  id        String   @id @default(cuid())
  name      String
  questions Json // Array of question objects
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== Admin: API Usage Logging ====================

model ApiUsageLog {
  id           String   @id @default(cuid())
  endpoint     String // e.g., "/api/transcribe", "/api/analyze"
  method       String // e.g., "POST"
  tokensUsed   Int? // Estimated tokens used for AI calls
  cost         Decimal? @db.Decimal(10, 4) // Estimated cost in dollars
  success      Boolean  @default(true)
  errorMessage String?  @db.Text
  durationMs   Int? // Request duration in milliseconds
  createdAt    DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== Admin: Subscription Payments ====================

model SubscriptionPayment {
  id          String                    @id @default(cuid())
  amount      Decimal                   @db.Decimal(10, 2)
  currency    String                    @default("ILS")
  status      SubscriptionPaymentStatus @default(PENDING)
  description String?
  invoiceUrl  String?
  periodStart DateTime?
  periodEnd   DateTime?
  paidAt      DateTime?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum SubscriptionPaymentStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
  REFUNDED
}

// ==================== Cancellation Requests ====================

model CancellationRequest {
  id         String                    @id @default(cuid())
  reason     String?                   @db.Text
  status     CancellationRequestStatus @default(PENDING)
  adminNotes String?                   @db.Text
  reviewedAt DateTime?
  createdAt  DateTime                  @default(now())
  updatedAt  DateTime                  @updatedAt

  sessionId String
  session   TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  reviewedById String?
  reviewedBy   User?   @relation(fields: [reviewedById], references: [id], onDelete: SetNull)
}

enum CancellationRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== Communication Log ====================

model CommunicationLog {
  id           String               @id @default(cuid())
  type         CommunicationType
  channel      CommunicationChannel @default(EMAIL)
  recipient    String
  subject      String?
  content      String               @db.Text
  status       CommunicationStatus  @default(PENDING)
  errorMessage String?              @db.Text
  sentAt       DateTime?
  createdAt    DateTime             @default(now())
  
  // Email tracking fields
  messageId    String?              // Resend message ID for tracking replies
  inReplyTo    String?              // ID of the message this is replying to
  isRead       Boolean              @default(false) // Has therapist read this reply?
  readAt       DateTime?            // When was it read?

  sessionId String?
  session   TherapySession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: SetNull)

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
}

enum CommunicationType {
  SESSION_CONFIRMATION
  REMINDER_24H
  REMINDER_2H
  CANCELLATION_REQUEST_TO_CLIENT
  CANCELLATION_REQUEST_TO_THERAPIST
  CANCELLATION_APPROVED
  CANCELLATION_REJECTED
  CUSTOM
  INCOMING_EMAIL
}

enum CommunicationChannel {
  EMAIL
  SMS
  WHATSAPP
}

enum CommunicationStatus {
  PENDING
  SENT
  FAILED
  RECEIVED
}

// ==================== Communication Settings ====================

model CommunicationSetting {
  id String @id @default(cuid())

  // Session notifications
  sendConfirmationEmail Boolean @default(true)
  send24hReminder       Boolean @default(true)
  send2hReminder        Boolean @default(false)

  // Cancellation policy
  allowClientCancellation Boolean @default(true)
  minCancellationHours    Int     @default(24)

  // Debt reminders
  sendDebtReminders       Boolean @default(false) // שליחת תזכורות חוב אוטומטיות
  debtReminderDayOfMonth  Int     @default(1)     // יום בחודש (1-28)
  debtReminderMinAmount   Decimal @default(50)    // סכום מינימלי לשליחת תזכורת

  // Payment receipts
  sendPaymentReceipt      Boolean @default(false) // שליחת קבלה אוטומטית אחרי תשלום
  sendReceiptToClient     Boolean @default(true)  // שלח קבלה למטופל
  sendReceiptToTherapist  Boolean @default(false) // שלח עותק למטפל
  receiptEmailTemplate    String? @db.Text        // תבנית מותאמת אישית לקבלה

  // Email customization
  paymentInstructions     String? @db.Text // הוראות תשלום מותאמות אישית
  paymentLink             String? // קישור לתשלום ישיר (ביט/פייבוקס וכו')
  emailSignature          String? @db.Text // חתימה אישית
  logoUrl                 String? // URL ללוגו
  customGreeting          String? // ברכת פתיחה מותאמת (למשל: "היי {שם}, מקווה שהשבוע עבר בטוב")
  customClosing           String? // ברכת סיום מותאמת (למשל: "תודה ומחכה לראותך")
  businessHours           String? // שעות פעילות (טקסט חופשי)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ==================== Billing & Payment Integration ====================

enum BillingProviderType {
  MESHULAM      // משולם - סליקה + קבלות
  ICOUNT        // iCount - קבלות בלבד
  GREEN_INVOICE // חשבונית ירוקה - קבלות בלבד
  SUMIT         // סאמיט - קבלות + סליקה
  PAYPLUS       // PayPlus - סליקה בלבד
  CARDCOM       // CardCom - סליקה בלבד
  TRANZILA      // טרנזילה - סליקה בלבד
}

model BillingProvider {
  id            String              @id @default(cuid())
  provider      BillingProviderType
  displayName   String              // שם להצגה (למשל: "Meshulam - חשבון ראשי")
  
  // API Credentials (מוצפן!)
  apiKey        String              @db.Text // ENCRYPTED
  apiSecret     String?             @db.Text // ENCRYPTED (אופציונלי)
  webhookSecret String?             @db.Text // לאימות Webhooks
  
  // הגדרות נוספות
  isActive      Boolean             @default(true)
  isPrimary     Boolean             @default(false) // האם זה הספק הראשי
  
  // הגדרות התנהגות
  settings      Json?               // { discreteMode: true, defaultDescription: "ייעוץ", autoSendReceipt: true }
  
  // מטא-דאטה
  lastSyncAt    DateTime?           // מתי התבצע סנכרון אחרון
  lastError     String?             @db.Text
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  
  // קשר למשתמש
  userId        String
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([provider])
  @@index([userId, isPrimary])
}

// ==================== Coupon System ====================

enum CouponType {
  SINGLE_USE     // קופון חד-פעמי - לקוח ספציפי
  LIMITED        // מוגבל למספר שימושים
  UNLIMITED      // ללא הגבלה
}

model Coupon {
  id          String      @id @default(cuid())
  code        String      @unique // הקוד עצמו
  name        String      // שם לתיאור (לנוחות ניהול)
  type        CouponType  @default(LIMITED)
  
  maxUses     Int?        // מקסימום שימושים (null = ללא הגבלה)
  usedCount   Int         @default(0) // כמה פעמים השתמשו
  
  discount    Int         @default(0) // אחוז הנחה (לעתיד)
  trialDays   Int         @default(30) // ימי ניסיון
  
  validFrom   DateTime    @default(now()) // תחילת תוקף
  validUntil  DateTime?   // תאריך תפוגה (null = ללא תפוגה)
  
  isActive    Boolean     @default(true) // האם פעיל
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  // מי השתמש בקופון
  usages      CouponUsage[]
}

model CouponUsage {
  id        String   @id @default(cuid())
  couponId  String
  userId    String
  usedAt    DateTime @default(now())
  
  coupon    Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([couponId, userId]) // משתמש יכול להשתמש בקופון פעם אחת
}

// ==================== Questionnaires ====================

model QuestionnaireTemplate {
  id          String   @id @default(cuid())
  code        String   @unique // e.g., "BDI2", "PCL5", "HAMA"
  name        String   // e.g., "מדד דיכאון בק"
  nameEn      String?  // e.g., "Beck Depression Inventory"
  description String?  @db.Text
  category    String?  // e.g., "דיכאון", "חרדה", "טראומה"
  testType    TestType @default(SELF_REPORT) // סוג המבחן
  questions   Json     // Array of questions with options
  scoring     Json?    // Scoring instructions
  stimuli     Json?    // For projective tests - images/cards
  subtests    Json?    // For intelligence tests - subtests
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  responses   QuestionnaireResponse[]
}

enum TestType {
  SELF_REPORT      // שאלון דיווח עצמי (BDI, PCL-5)
  CLINICIAN_RATED  // הערכה קלינית (HAM-A)
  PROJECTIVE       // מבחן השלכתי (רורשאך, TAT)
  INTELLIGENCE     // מבחן אינטליגנציה (וקסלר)
  NEUROPSYCH       // מבחן נוירופסיכולוגי (Bender)
  INTERVIEW        // ראיון מובנה (SCID)
}

model QuestionnaireResponse {
  id            String   @id @default(cuid())
  answers       Json     // Array of answers
  totalScore    Int?     // Calculated total score
  subscores     Json?    // Category/criterion scores
  aiAnalysis    String?  @db.Text // AI analysis of results
  status        QuestionnaireStatus @default(IN_PROGRESS)
  startedAt     DateTime @default(now())
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  templateId    String
  template      QuestionnaireTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  clientId      String
  client        Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  therapistId   String
  therapist     User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  
  // AI Analysis Relations
  questionnaireAnalyses QuestionnaireAnalysis[]
}

enum QuestionnaireStatus {
  IN_PROGRESS
  COMPLETED
  ANALYZED
}

// ==================== Intake Questionnaires (Simple) ====================

model IntakeQuestionnaire {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation("intakeQuestionnaires", fields: [userId], references: [id], onDelete: Cascade)
  
  name        String   // "תשאול ראשוני"
  description String?  // תיאור קצר
  isDefault   Boolean  @default(false)  // ברירת מחדל?
  isActive    Boolean  @default(true)   // פעיל?
  questions   Json     // מערך שאלות פשוטות
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  responses   IntakeResponse[]
  
  @@index([userId])
  @@index([userId, isDefault])
}

model IntakeResponse {
  id         String   @id @default(cuid())
  clientId   String
  client     Client   @relation("intakeResponses", fields: [clientId], references: [id], onDelete: Cascade)
  templateId String
  template   IntakeQuestionnaire @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  responses  Json     // התשובות (key-value pairs)
  filledAt   DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([clientId])
  @@index([templateId])
}

// ==================== SMS Reminders ====================

model SMSReminder {
  id            String   @id @default(cuid())
  phoneNumber   String
  message       String   @db.Text
  scheduledFor  DateTime
  sentAt        DateTime?
  status        SMSStatus @default(PENDING)
  errorMessage  String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessionId String
  session   TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([scheduledFor])
  @@index([status])
}

enum SMSStatus {
  PENDING
  SENT
  FAILED
  CANCELLED
}

model SMSSettings {
  id                    String   @id @default(cuid())
  enabled               Boolean  @default(false)
  hoursBeforeReminder   Int      @default(24) // Hours before session to send reminder
  customMessage         String?  @db.Text
  sendOnWeekends        Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  therapistId String @unique
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)
}

// ==================== Consent Forms ====================

model ConsentForm {
  id            String   @id @default(cuid())
  type          ConsentType
  title         String
  content       String   @db.Text // HTML content of the form
  isTemplate    Boolean  @default(false) // Is this a reusable template?
  signedAt      DateTime?
  signatureData String?  @db.Text // Base64 signature image
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  clientId String?
  client   Client? @relation(fields: [clientId], references: [id], onDelete: Cascade)

  therapistId String
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([clientId])
}

enum ConsentType {
  TREATMENT_AGREEMENT    // הסכם טיפול
  INFORMED_CONSENT       // הסכמה מדעת
  CONFIDENTIALITY        // הסכם סודיות
  RECORDING_CONSENT      // הסכמה להקלטה
  TELEHEALTH_CONSENT     // הסכמה לטיפול מרחוק
  PARENTAL_CONSENT       // הסכמת הורים (קטינים)
  CUSTOM                 // טופס מותאם אישית
}

// ==================== Health Insurance Integration ====================

model InsurerSettings {
  id          String   @id @default(cuid())
  enabled     Boolean  @default(false)
  
  // Clalit - כללית
  clalitEnabled    Boolean @default(false)
  clalitApiKey     String?
  clalitFacilityId String?
  
  // Maccabi - מכבי
  maccabiEnabled    Boolean @default(false)
  maccabiApiKey     String?
  maccabiProviderId String?
  
  // Meuhedet - מאוחדת
  meuhedetEnabled  Boolean @default(false)
  meuhedetUsername String?
  meuhedetPassword String?
  
  // Leumit - לאומית
  leumitEnabled   Boolean @default(false)
  leumitApiKey    String?
  leumitClinicCode String?
  
  autoSubmit      Boolean @default(false) // Auto-submit reports after session
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  therapistId String @unique
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)
}

model InsurerReport {
  id              String   @id @default(cuid())
  insurer         HealthInsurer
  reportData      String   @db.Text // JSON formatted report
  status          ReportStatus @default(DRAFT)
  submittedAt     DateTime?
  confirmationCode String?
  errorMessage    String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessionId String
  session   TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  therapistId String
  therapist   User   @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([insurer])
  @@index([status])
  @@index([sessionId])
}

enum HealthInsurer {
  CLALIT
  MACCABI
  MEUHEDET
  LEUMIT
}

enum ReportStatus {
  DRAFT
  PENDING
  SUBMITTED
  CONFIRMED
  REJECTED
  ERROR
}

// ==================== AI Usage Tracking ====================

model AIUsageStats {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Current month stats
  currentMonthCalls   Int      @default(0)
  currentMonthTokens  Int      @default(0)
  currentMonthCost    Decimal  @default(0) @db.Decimal(10, 4)
  
  // Daily stats (reset every day)
  dailyCalls          Int      @default(0)
  lastResetDate       DateTime @default(now())
  
  // All-time stats
  totalCalls          Int      @default(0)
  totalCost           Decimal  @default(0) @db.Decimal(10, 4)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([userId])
}

model SessionPrep {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  clientId          String
  sessionDate       DateTime
  
  // AI Analysis content
  content           String   @db.Text
  insights          Json?    // Structured insights
  recommendations   Json?    // Structured recommendations
  
  // Metadata
  aiModel           String   // "gpt-4o", "gpt-4o-mini", "gemini-1.5-flash"
  tokensUsed        Int
  cost              Decimal  @db.Decimal(10, 4)
  generatedAt       DateTime @default(now())
  
  createdAt         DateTime @default(now())
  
  @@index([userId, sessionDate])
  @@index([clientId])
}

// ==================== Admin Global Settings ====================

model GlobalAISettings {
  id                    String   @id @default(cuid())
  
  // Rate limits
  dailyLimitEssential   Int      @default(0)    // 0 = no AI
  dailyLimitPro         Int      @default(30)   // 30 calls/day
  dailyLimitEnterprise  Int      @default(100)  // 100 calls/day
  
  monthlyLimitEssential Int      @default(0)    // 0 = no AI
  monthlyLimitPro       Int      @default(600)  // 600 calls/month
  monthlyLimitEnterprise Int     @default(2000) // 2000 calls/month
  
  // Cost controls
  maxMonthlyCostBudget  Decimal  @default(5000) @db.Decimal(10, 2) // Total budget cap
  alertThreshold        Decimal  @default(4000) @db.Decimal(10, 2) // Alert at 80%
  
  // Behavior on limit exceed
  blockOnExceed         Boolean  @default(false) // Block user or just alert
  alertAdminOnExceed    Boolean  @default(true)
  
  // Feature flags
  enableCache           Boolean  @default(true)  // Cache identical requests
  compressPrompts       Boolean  @default(true)  // Compress long prompts
  
  updatedAt             DateTime @updatedAt
  
  @@map("global_ai_settings")
}

// ==================== AI Insights System ====================

model AIInsight {
  id          String       @id @default(cuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId    String
  client      Client       @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  type        InsightType  // Type of insight
  title       String       // Short title
  content     String       @db.Text // Full content
  confidence  Float        // 0-1, how confident the AI is
  
  metadata    Json?        // Additional structured data
  
  // Caching and validity
  validUntil  DateTime     // When this insight expires
  isStale     Boolean      @default(false)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([clientId, type])
  @@index([userId, createdAt])
  @@index([validUntil])
}

enum InsightType {
  PATTERN           // Behavioral patterns
  EMOTION_TREND     // Emotional tracking
  GOAL_PROGRESS     // Goal achievement
  TECHNIQUE_REC     // Technique recommendations
  OPEN_ISSUE        // Unresolved topics
  RELATIONSHIP_MAP  // Key relationships
  RISK_FLAG         // Warning signs
}

model TherapeuticGoal {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  title         String   // Goal description
  category      String?  // e.g., "anxiety", "depression", "relationships"
  
  // Progress tracking
  startValue    Int      // Initial score (e.g., 8/10)
  targetValue   Int      // Target score (e.g., 3/10)
  currentValue  Int      // Current score
  unit          String   @default("scale") // "scale", "frequency", "percentage"
  
  // Calculated
  progress      Float    // Percentage progress (0-100)
  trend         String   // "improving", "stable", "declining"
  
  // Timeline
  startDate     DateTime @default(now())
  targetDate    DateTime?
  lastUpdated   DateTime @updatedAt
  status        GoalStatus @default(ACTIVE)
  
  createdAt     DateTime @default(now())
  
  @@index([clientId, status])
  @@index([userId])
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  PAUSED
  ABANDONED
}

model EmotionLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  sessionId   String?
  session     TherapySession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Emotion data
  emotion     String   // Primary emotion detected
  intensity   Int      // 1-10
  valence     String   // "positive", "negative", "neutral"
  
  // Context
  context     String?  @db.Text
  triggers    Json?    // Array of trigger keywords
  
  // Source
  source      String   @default("ai_analysis") // "ai_analysis", "manual", "questionnaire"
  
  recordedAt  DateTime @default(now())
  
  @@index([clientId, recordedAt])
  @@index([userId])
}

// ==================== Questionnaire Analysis ====================

model QuestionnaireAnalysis {
  id                String   @id @default(cuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  clientId          String
  client            Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  
  // Analysis type
  analysisType      QuestionnaireAnalysisType
  
  // Single questionnaire analysis
  responseId        String?
  response          QuestionnaireResponse? @relation(fields: [responseId], references: [id], onDelete: Cascade)
  
  // Combined analysis - multiple questionnaires
  responseIds       String[] // Array of response IDs if combined analysis
  
  // Progress report - questionnaires + session summaries
  sessionIds        String[] // Array of session IDs if progress report
  dateFrom          DateTime?
  dateTo            DateTime?
  
  // Analysis content
  content           String   @db.Text
  insights          Json?    // Structured insights
  recommendations   Json?    // Structured recommendations
  
  // Metadata
  aiModel           String   // "gpt-4o", "gpt-4o-mini", "gemini-1.5-flash"
  tokensUsed        Int
  cost              Decimal  @db.Decimal(10, 4)
  
  createdAt         DateTime @default(now())
  
  @@index([userId, clientId])
  @@index([clientId, createdAt])
  @@index([analysisType])
}

enum QuestionnaireAnalysisType {
  SINGLE           // Single questionnaire
  COMBINED         // All questionnaires for a client
  PROGRESS_REPORT  // Questionnaires + session summaries over time
}

// ==================== Session Analysis (Detailed/Concise) ====================

model SessionAnalysis {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionId   String   @unique
  session     TherapySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  // Analysis type
  analysisType AnalysisType
  
  // Content
  content     String   @db.Text
  insights    Json?    // Structured insights
  
  // Metadata
  aiModel     String   // "gpt-4o", "gemini-1.5-flash"
  tokensUsed  Int
  cost        Decimal  @db.Decimal(10, 4)
  
  createdAt   DateTime @default(now())
  
  @@index([userId, sessionId])
  @@index([analysisType])
}

enum AnalysisType {
  CONCISE   // Short analysis (0.5 pages)
  DETAILED  // Detailed analysis (2-3 pages)
}

// ==================== Tier Usage Limits ====================

model TierLimits {
  id                    String   @id @default(cuid())
  tier                  AITier   @unique
  
  // הכנות לפגישה
  sessionPrepLimit      Int      @default(0)      // 0 = ללא הגבלה, -1 = חסום
  
  // ניתוחי פגישה
  conciseAnalysisLimit  Int      @default(0)      // תמציתי
  detailedAnalysisLimit Int      @default(0)      // מפורט
  
  // ניתוחי שאלונים
  singleQuestionnaireLimit  Int  @default(0)      // שאלון בודד
  combinedQuestionnaireLimit Int @default(0)      // ניתוח משולב
  progressReportLimit       Int  @default(0)      // דוח התקדמות
  
  // תיאור התוכנית
  displayNameHe         String   @default("")     // שם בעברית
  displayNameEn         String   @default("")     // שם באנגלית
  priceMonthly          Int      @default(0)      // מחיר חודשי בשקלים
  description           String?  @db.Text         // תיאור התוכנית
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@map("tier_limits")
}

// ==================== Admin Email Templates ====================

model AdminEmailTemplate {
  id            String            @id @default(cuid())
  type          EmailTemplateType
  
  // Email content
  subject       String
  bodyHtml      String            @db.Text
  bodyText      String?           @db.Text
  
  // Placeholders documentation
  placeholders  Json?             // { "{name}": "שם המשתמש", "{amount}": "סכום" }
  
  isActive      Boolean           @default(true)
  
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  
  @@unique([type])
  @@map("admin_email_templates")
}

enum EmailTemplateType {
  PAYMENT_REMINDER        // תזכורת תשלום
  PAYMENT_OVERDUE         // תשלום באיחור
  SUBSCRIPTION_EXPIRING   // מנוי עומד לפוג
  SUBSCRIPTION_EXPIRED    // מנוי פג
  WELCOME_NEW_USER        // ברוך הבא
  TIER_UPGRADE            // שדרוג תוכנית
  TIER_DOWNGRADE          // שנמוך תוכנית
  CUSTOM                  // מותאם אישית
}

// ==================== Monthly Usage Tracking ====================

model MonthlyUsage {
  id                        String   @id @default(cuid())
  userId                    String
  user                      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  month                     Int      // 1-12
  year                      Int      // 2024, 2025, etc.
  
  // Session Prep (daily automatic)
  sessionPrepCount          Int      @default(0)
  
  // Session Analysis
  conciseAnalysisCount      Int      @default(0)  // Unlimited (1 per session)
  detailedAnalysisCount     Int      @default(0)  // Enterprise: 10/month
  
  // Questionnaire Analysis
  singleQuestionnaireCount  Int      @default(0)  // Pro: 60, Enterprise: 80
  combinedQuestionnaireCount Int     @default(0)  // Pro: 30, Enterprise: 40
  progressReportCount       Int      @default(0)  // Pro: 15, Enterprise: 20
  
  // Total costs
  totalCost                 Decimal  @default(0) @db.Decimal(10, 4)
  totalTokens               Int      @default(0)
  
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  
  @@unique([userId, month, year])
  @@index([userId, year, month])
}
